<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agrimonitor - Tablero de la Gente de Ventas</title>
  
  <!-- Fuente Google: Poppins -->
  <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,600&display=swap" rel="stylesheet" />
  
  <!-- Hoja de estilos principal -->
  <link rel="stylesheet" href="styles.css" />
  
  <!-- Librería Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  
  <!-- Librería de íconos (Font Awesome) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  
  <!-- Librería Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- PapaParse para CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  
  <style>
    /* Estilos para la barra lateral (sidebar) */
    .sidebar {
      width: 250px;
      background-color: #1d5c59;
      color: #ecf0f1;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: fixed;
      top: 0;
      left: 0;
      padding: 20px;
      box-sizing: border-box;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .sidebar-profile {
      text-align: center;
      margin-bottom: 20px;
    }
    .sidebar-profile img {
      border-radius: 50%;
    }
    .sidebar .menu ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .sidebar .menu ul li {
      margin: 10px 0;
    }
    .sidebar .menu ul li a {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      color: #ecf0f1;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.3s ease, padding-left 0.3s ease;
    }
    .sidebar .menu ul li a i {
      font-size: 1.1rem;
    }
    .sidebar .menu ul li.active a,
    .sidebar .menu ul li a:hover {
      background-color: #1d5c59;
      padding-left: 20px;
    }
    .sidebar-footer {
      text-align: center;
    }
    .sidebar-footer button,
    .sidebar-footer a {
      background: none;
      border: none;
      color: #ecf0f1;
      cursor: pointer;
      margin: 5px 0;
      font-size: 0.9rem;
    }
    
    /* Ajuste del contenedor principal para dar espacio a la sidebar */
    .main-content {
      margin-left: 250px;
      padding: 20px;
      font-family: 'Poppins', sans-serif;
      background-color: #fff;
    }
    
    /* Ajustes rápidos para el canvas de la gráfica */
    .chart-card canvas {
      width: 100% !important;
      height: 250px !important;
    }

    /* Asegura que el contenedor del mapa tenga altura */
    .map-container {
      width: 100%;
      height: 400px; /* Ajusta según tu diseño */
      border: 1px solid #ccc;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 20px; /* Según el espaciado que desees */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    #map {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Mejoras generales de estética */
    body {
      background-color: #f9f9f9;
      color: #333;
    }

    /* Contenedor de filtros */
    .filter-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 5px;
    }

    /* Calendario con grid para mayor orden */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      background-color: #fff;
      padding: 10px;
      border-radius: 5px;
    }

    .calendar div {
      padding: 8px;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 3px;
    }

    .calendar-event {
      background-color: #e3f2fd;
      font-size: 0.9rem;
      font-weight: bold;
    }

    /* Mejoras en modales */
    .modal .modal-content {
      border-radius: 8px;
      padding: 20px;
      background-color: #fff;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    /* Estilos específicos para la agenda */
    .agenda-container {
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-top: 20px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .calendar-navigation {
      display: flex;
      gap: 10px;
    }

    .calendar-navigation button {
      padding: 8px 15px;
      border: none;
      background-color: #1d5c59;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      background-color: #fff;
      padding: 10px;
      border-radius: 5px;
    }

    .calendar-day {
      padding: 10px;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 80px;
    }

    .calendar-event {
      background-color: #e3f2fd;
      padding: 5px;
      margin: 2px 0;
      border-radius: 3px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .add-event-button {
      padding: 10px 20px;
      background-color: #1d5c59;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    /* Corregir estilo del menú izquierdo */
    .sidebar {
      width: 250px;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      background-color: #1d5c59;
      color: #ecf0f1;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      z-index: 1001;
    }
    
    .sidebar-profile {
      text-align: center;
      margin-bottom: 30px;
      width: 100%;
    }
    
    .sidebar-profile img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
      border: 3px solid rgba(255, 255, 255, 0.2);
    }
    
    .sidebar .menu {
      width: 100%;
    }
    
    .sidebar .menu ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      width: 100%;
    }
    
    .sidebar .menu ul li {
      margin: 8px 0;
      width: 100%;
    }
    
    .sidebar .menu ul li a {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 15px;
      color: #ecf0f1;
      text-decoration: none;
      border-radius: 5px;
      transition: all 0.3s ease;
      width: 100%;
      box-sizing: border-box;
    }
    
    .sidebar .menu ul li a i {
      width: 20px;
      text-align: center;
      font-size: 1.1rem;
    }
    
    .sidebar .menu ul li.active a,
    .sidebar .menu ul li a:hover {
      background-color: #1d5c59;
      padding-left: 20px;
    }
    
    .sidebar-footer {
      margin-top: auto;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-top: 20px;
      width: 100%;
    }
    
    .sidebar-footer button,
    .sidebar-footer a {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 10px 15px;
      margin: 5px 0;
      background: none;
      border: none;
      color: #ecf0f1;
      text-align: left;
      cursor: pointer;
      border-radius: 5px;
      transition: background 0.3s ease;
      text-decoration: none;
    }
    
    .sidebar-footer button:hover,
    .sidebar-footer a:hover {
      background-color: #1d5c59;
    }

    /* Estilos para el calendario y paneles laterales */
    .content-wrapper {
      padding: 20px;
    }

    .calendar-section {
      background-color: #fff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .calendar-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 20px;
    }

    .calendar-day {
      padding: 10px;
      min-height: 100px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: #fff;
    }

    .calendar-day.header {
      min-height: auto;
      font-weight: bold;
      text-align: center;
      background: #f5f5f5;
    }

    .calendar-event {
      margin: 2px 0;
      padding: 4px 8px;
      background-color: #e8f5e9;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .side-panels {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .reminders-panel, .notifications-panel {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .reminders-header, .notifications-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .title-with-icon {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .reminders-actions {
      display: flex;
      gap: 10px;
    }

    .btn-link {
      color: #1d5c59;
      background: none;
      border: none;
      cursor: pointer;
    }

    .btn-primary {
      background: #1d5c59;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .reminder-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .reminder-content {
      flex: 1;
    }

    .reminder-content h3 {
      margin: 0;
      font-size: 0.9rem;
    }

    .reminder-content p {
      margin: 5px 0 0;
      color: #666;
      font-size: 0.8rem;
    }

    .reminder-status {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ffb74d;
    }

    .reminder-status.completed {
      background: #81c784;
    }

    .notification-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
    }

    .notification-content h3 {
      margin: 0;
      font-size: 0.9rem;
      color: #333;
    }

    .notification-content p {
      margin: 5px 0;
      color: #666;
      font-size: 0.85rem;
    }

    .notification-content button {
      background: #1d5c59;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      margin-top: 5px;
    }

    /* Ajustes responsivos */
    @media (min-width: 1024px) {
      .side-panels {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body class="has-sidebar">
  <!-- SIDEBAR -->
  <aside class="sidebar" style="display: flex; flex-direction: column;">
    <div>
      <div class="sidebar-profile">
        <img src="https://scontent.fcvj5-1.fna.fbcdn.net/v/t39.30808-6/493125038_685139734404058_5788015028353864134_n.jpg?_nc_cat=100&ccb=1-7&_nc_sid=833d8c&_nc_ohc=2HJpAiRI9XsQ7kNvwFeltDD&_nc_oc=AdmEetw5xa9ARhaYIlBZUGquqouFwc3V_4zBzTMq45x41M2qfDPeLrGRzLClXo8toKmsg6BOgWmf1_7CdVN8bUKR&_nc_zt=23&_nc_ht=scontent.fcvj5-1.fna&_nc_gid=ylZKEG8nDw8Uwdzvt1wHmA&oh=00_AfIMeLHR5kfFxGz5n_TjiB-f8FTYZXE5j9UQCwzy0nPE0w&oe=6839B38E" alt="KaptiaBot" />
        <div class="profile-info">
          <h3>KaptiaBot</h3>
        </div>
      </div>
      <nav class="menu">
        <ul>
          <li class="active"><a href="home.html"><i class="fas fa-home"></i> Página de inicio</a></li>
          <li><a href="#"><i class="fas fa-map"></i> Mapa interactivo</a></li>
          <li><a href="#"><i class="fas fa-users"></i> Mis clientes</a></li>
          <li><a href="#"><i class="fas fa-chart-line"></i> Métricas clave</a></li>
          <li><a href="agenda.html"><i class="fas fa-calendar"></i> Agenda</a></li>
          <li><a href="#"><i class="fas fa-envelope"></i> Mensajes</a></li>
          <li><a href="#"><i class="fas fa-headset"></i> Contacta un asesor</a></li>
        </ul>
      </nav>
    </div>
    <div class="sidebar-footer">
      <a href="#"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
    </div>
  </aside>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="main-content">
    <header class="topbar">
      <h1>Página de inicio</h1>
      <div class="topbar-actions">
        <!-- Buscador y Avatar -->
        <div class="search-user-section">
        <div class="search-bar">
          <i class="fas fa-search"></i>
            <input type="text" placeholder="Preguntar a KaptiaBot o buscar" />
        </div>
          <div class="user-profile">
            <img src="https://media.licdn.com/dms/image/v2/D5603AQEw-UoZ06Kb-A/profile-displayphoto-shrink_200_200/B56ZcELhdZHwAc-/0/1748121819494?e=1753315200&v=beta&t=umlB7AE5ew2DhHiSiN3-sUj3KmX2enK5mF7vCQyGtME" alt="Usuario" class="avatar" />
            <div class="dropdown-menu" id="userMenu">
              <a href="#"><i class="fas fa-user"></i> Ver perfil</a>
              <a href="#"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="content-wrapper">
      <!-- Contenedor para las diferentes secciones -->
      <div id="inicio-section" class="content-section active">
        <h1>¡Hola Mariel!</h1>
        
        <!-- Calendario de Citas -->
        <div class="calendar-section">
          <div class="calendar-header">
            <h2>Calendario de Citas - Mayo 2025</h2>
            <div class="calendar-actions">
              <button class="add-event-button">
                <i class="fas fa-plus"></i> Nueva Cita
              </button>
              <div class="calendar-navigation">
                <button id="prevMonth"><i class="fas fa-chevron-left"></i> Anterior</button>
                <button id="nextMonth">Siguiente <i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>

          <div class="calendar">
            <!-- Los días y eventos se generarán dinámicamente con JavaScript -->
          </div>
        </div>

        <!-- Recordatorios y Notificaciones -->
        <div class="side-panels">
          <div class="reminders-panel">
            <div class="reminders-header">
              <div class="title-with-icon">
                <i class="fas fa-bell"></i>
                <h2>Recordatorios</h2>
              </div>
              <div class="reminders-actions">
                <button class="btn-link">Mostrar todos</button>
                <button class="btn-primary">Añadir+</button>
              </div>
            </div>
            <div class="reminders-list">
              <div class="reminder-item">
                <i class="fas fa-video"></i>
                <div class="reminder-content">
                  <h3>Zoom Agrotienda (CDMX)</h3>
                  <p>9:00 hrs - Vie 14 mar</p>
                </div>
                <div class="reminder-status"></div>
              </div>
              <div class="reminder-item">
                <i class="fas fa-building"></i>
                <div class="reminder-content">
                  <h3>Visita Cliente Invernaderos SA</h3>
                  <p>14:30 hrs - Vie 14 mar</p>
                </div>
                <div class="reminder-status completed"></div>
              </div>
            </div>
          </div>

          <div class="notifications-panel">
            <div class="notifications-header">
              <div class="title-with-icon">
                <i class="fas fa-bell"></i>
                <h2>Notificaciones</h2>
              </div>
            </div>
            <div class="notifications-list">
              <div class="notification-item">
                <div class="notification-content">
                  <h3>OFICINAS ADMINISTRATIVAS DE INVERNADEROS BONANZA 2001 (Jalisco)</h3>
                  <p>Cliente respondió y agendó cita.</p>
                  <button onclick="mostrarAlerta('OFICINAS ADMINISTRATIVAS DE INVERNADEROS BONANZA 2001 (Jalisco)')">Ver Detalles</button>
                </div>
              </div>
              <div class="notification-item">
                <div class="notification-content">
                  <h3>BAJA PK (Baja California)</h3>
                  <p>Cliente confirmó interés.</p>
                  <button onclick="mostrarAlerta('BAJA PK (Baja California)')">Ver Detalles</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- POP-UP Overlay para Alertas -->
  <div class="popup-overlay" id="overlayAlerta">
    <div class="popup">
      <h2 id="tituloAlerta">Detalles</h2>
      <p>Aquí se mostrarán más datos sobre la alerta seleccionada.</p>
      <button onclick="cerrarAlerta()">Cerrar</button>
    </div>
  </div>

  <!-- MODALES -->
  <!-- Modal de Curso: Estrategias de Venta Avanzadas -->
  <div class="course-modal" id="modalVentas">
    <div class="course-modal-content">
      <span class="close-modal" onclick="cerrarModalCurso('modalVentas')">&times;</span>
      <h2>Estrategias de Venta Avanzadas</h2>
      <p>
        En este curso aprenderás técnicas avanzadas para captar clientes y cerrar ventas en el sector agrícola.
      </p>
      <ul>
        <li>Módulo 1: Análisis del Mercado</li>
        <li>Módulo 2: Prospección Efectiva</li>
        <li>Módulo 3: Técnicas de Negociación</li>
      </ul>
    </div>
  </div>

  <!-- Modal de Curso: Técnicas de Prospección -->
  <div class="course-modal" id="modalRiego">
    <div class="course-modal-content">
      <span class="close-modal" onclick="cerrarModalCurso('modalRiego')">&times;</span>
      <h2>Técnicas de Prospección</h2>
      <p>
        Aprende a identificar y acercarte a clientes potenciales de forma efectiva.
      </p>
      <button onclick="alert('Iniciando Evaluación de Prospección...')">Iniciar Evaluación</button>
    </div>
  </div>

  <!-- Modal de Curso: Negociación y Cierre de Ventas -->
  <div class="course-modal" id="modalEco">
    <div class="course-modal-content">
      <span class="close-modal" onclick="cerrarModalCurso('modalEco')">&times;</span>
      <h2>Negociación y Cierre de Ventas</h2>
      <p>
        Descubre estrategias para negociar, superar objeciones y cerrar ventas efectivas.
      </p>
      <ul>
        <li>Técnicas de Cierre</li>
        <li>Manejo de Objeciones</li>
        <li>Seguimiento Post-Venta</li>
      </ul>
    </div>
  </div>

  <!-- Modal de Curso: Manejo de Seguimiento Comercial -->
  <div class="course-modal" id="modalClima">
    <div class="course-modal-content">
      <span class="close-modal" onclick="cerrarModalCurso('modalClima')">&times;</span>
      <h2>Manejo de Seguimiento Comercial</h2>
      <p>
        Aprende a mantener relaciones efectivas y dar seguimiento a clientes para aumentar tus ventas.
      </p>
      <p><strong>Próxima sesión:</strong> Viernes 15, 9 AM (Online)</p>
    </div>
  </div>

  <!-- Modal de KPI: Detalle de Ventas -->
  <div class="course-modal" id="modalKpiVentas">
    <div class="course-modal-content">
      <span class="close-modal" onclick="cerrarModalCurso('modalKpiVentas')">&times;</span>
      <h2>Detalle de Ventas</h2>
      <p>
        Este indicador muestra el total de unidades vendidas durante el mes.
      </p>
      <p>
        <strong>Objetivo:</strong> 200 unidades<br/>
        <strong>Resultado actual:</strong> 120 unidades
      </p>
    </div>
  </div>

  <!-- Modal de Gráfica: Evolución de Ventas -->
  <div class="course-modal" id="modalGraficaVentas">
    <div class="course-modal-content">
      <span class="close-modal" onclick="cerrarModalCurso('modalGraficaVentas')">&times;</span>
      <h2>Datos sobre Evolución de Ventas</h2>
      <p>
        La gráfica muestra la evolución de las ventas a lo largo de los meses.
      </p>
      <ul>
        <li>Enero: 15 unidades</li>
        <li>Febrero: 20 unidades</li>
        <li>Marzo: 25 unidades</li>
        <li>Abril: 30 unidades</li>
        <li>Mayo: 20 unidades</li>
        <li>Junio: 10 unidades</li>
      </ul>
    </div>
  </div>

  <!-- Modal de Gráfica: Ahorro de Agua -->
  <div class="course-modal" id="modalGrafica">
    <div class="course-modal-content">
      <span class="close-modal" onclick="cerrarModalCurso('modalGrafica')">&times;</span>
      <h2>Datos sobre el Ahorro de Agua</h2>
      <p>
        Esta gráfica representa la evolución del ahorro de agua (litros acumulados) a lo largo de los meses.
      </p>
      <ul>
        <li>Enero: 500 L</li>
        <li>Febrero: 800 L</li>
        <li>Marzo: 1200 L</li>
        <li>Abril: 1800 L</li>
        <li>Mayo: 2700 L</li>
        <li>Junio: 3500 L</li>
      </ul>
    </div>
  </div>

  <!-- Modal para Propuesta de Venta -->
  <div class="modal" id="proposalModal">
    <div class="modal-content" id="proposalModalContent">
      <span class="close-btn" id="closeProposalModal">&times;</span>
      <h3>Propuesta de Venta</h3>
      <p><strong>Empresa Seleccionada:</strong> <span id="proposalCompanyName"></span></p>
      <p id="proposalText">Detalla la propuesta de venta de soluciones y servicios para este cliente.</p>
      <div class="btn-group">
        <button class="close-sale" id="markSaleClosedBtn">Venta Cerrada</button>
        <button class="pending-sale" id="markSalePendingBtn">Mantener Pendiente</button>
      </div>
      <p style="margin-top:15px;"><strong>Estado de la Venta:</strong> <span id="saleStatusText">Pendiente</span></p>
    </div>
  </div>

  <!-- Modal del Dashboard (Chatbot fake) -->
  <div class="modal" id="dashboardModal">
    <div class="modal-content">
      <span class="close-btn" id="closeDashboardModal">&times;</span>
      <h3>Dashboard de Ventas</h3>
      <p>Aquí se muestran estadísticas y un asistente virtual para ayudarte en la toma de decisiones.</p>
      <div style="margin-top:15px; padding:10px; border:1px solid #ccc; border-radius:4px;">
        <p><strong>Chatbot:</strong> Hola, ¿en qué puedo ayudarte hoy?</p>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="scripts.js"></script>
  <script>
    // Funciones de scroll suave y resaltado (si aplica)
    document.addEventListener("DOMContentLoaded", () => {
      const sections = document.querySelectorAll("section[id]");
      const navLinks = document.querySelectorAll(".scroll-link");
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const id = entry.target.getAttribute("id");
              navLinks.forEach((link) => {
                link.classList.remove("active");
                if (link.getAttribute("href") === "#" + id) {
                  link.classList.add("active");
                }
              });
            }
          });
        },
        { threshold: 0.3 }
      );
      sections.forEach((section) => observer.observe(section));
      navLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const targetId = link.getAttribute("href").substring(1);
          document.getElementById(targetId).scrollIntoView({ behavior: "smooth" });
        });
      });
      
      // =======================================
      // 1. INICIALIZACIÓN DEL MAPA
      // =======================================
      const map = L.map("map").setView([23.634501, -102.552784], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
      }).addTo(map);
      
      // =======================================
      // 2. CARGA DEL ARCHIVO GEOJSON
      // =======================================
      let geojsonLayer = null;
      let geojsonData = null;
      
      function updateGeoJSONLayer(data) {
        if (geojsonLayer) {
          map.removeLayer(geojsonLayer);
        }
        geojsonLayer = L.geoJSON(data, {
          pointToLayer: function(feature, latlng) {
            let color = "#4CAF50";
            if (feature.properties.prioridad_venta === "Alta") {
              color = "#1B5E20";
            } else if (feature.properties.prioridad_venta === "Baja") {
              color = "#C62828";
            }
            return L.circleMarker(latlng, {
              radius: 8,
              fillColor: color,
              color: "#fff",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            });
          },
          onEachFeature: function(feature, layer) {
            const props = feature.properties;
            const lat = feature.geometry.coordinates[1];
            const lng = feature.geometry.coordinates[0];
            layer.bindPopup(`
              <b>ID:</b> ${props.id}<br>
              <b>Establecimiento:</b> ${props.nom_estab}<br>
              <b>Razón Social:</b> ${props.raz_social}<br>
              <b>Actividad:</b> ${props.nombre_act}<br>
              <b>Teléfono:</b> ${props.telefono}<br>
              <b>Correo:</b> ${props.correoelec}<br>
              <b>Página Web:</b> ${props.www ? props.www : "No disponible"}<br>
              <b>Entidad:</b> ${props.entidad}<br>
              <b>Municipio:</b> ${props.municipio}<br>
              <b>Localidad:</b> ${props.localidad}<br>
              <b>Coordenadas:</b> ${lat}, ${lng}<br><br>
              <button onclick="openProposalModal(${props.id})">Generar Propuesta</button>
            `);
          }
        }).addTo(map);
      }
      
      function loadGeoJSON() {
        fetch("nube.geojson")
          .then(response => response.json())
          .then(data => {
            geojsonData = data;
            updateGeoJSONLayer(data);
            updateClientesList(data.features);
          })
          .catch(err => console.error("Error cargando el GeoJSON:", err));
      }
      
      loadGeoJSON();
      
      // =======================================
      // 3. FILTROS BASADOS EN GEOJSON
      // =======================================
      const filterEstado = document.getElementById("filterEstado");
      const filterPrioridad = document.getElementById("filterPrioridad");
      const filterCanal = document.getElementById("filterCanal");
      
      function applyFilters() {
        if (!geojsonData) return;
        const estadoValor = filterEstado ? filterEstado.value : "";
        const prioridadValor = filterPrioridad ? filterPrioridad.value : "";
        const canalValor = filterCanal ? filterCanal.value : "";
        
        const filteredFeatures = geojsonData.features.filter(feature => {
          const props = feature.properties;
          const matchEstado = estadoValor ? props.entidad === estadoValor : true;
          const matchPrioridad = prioridadValor ? props.prioridad_venta === prioridadValor : true;
          const matchCanal = canalValor ? props.canal_preferido === canalValor : true;
          return matchEstado && matchPrioridad && matchCanal;
        });
        
        const filteredGeoJSON = {
          type: "FeatureCollection",
          features: filteredFeatures
        };
        
        updateGeoJSONLayer(filteredGeoJSON);
        updateClientesList(filteredFeatures);
      }
      
      // Aplicar filtros al cambiar cualquier selector
      [filterEstado, filterPrioridad, filterCanal].forEach(select => {
        if (select) select.addEventListener("change", applyFilters);
      });
      
      // Ejecutar una vez para poblar el select Estado
      const interval = setInterval(() => {
        if (geojsonData) {
          // Poblar select de Estado dinámicamente
          const estados = Array.from(new Set(geojsonData.features.map(feature => 
            feature.properties.entidad)));
          filterEstado.innerHTML = '<option value="">Estado: Todos</option>';
          estados.sort();
          estados.forEach(estado => {
            filterEstado.innerHTML += `<option value="${estado}">${estado}</option>`;
          });
          clearInterval(interval);
        }
      }, 100);
      
      // =======================================
      // 4. KPI y GRÁFICA CON CHART.JS
      // =======================================
      if (document.getElementById("kpiVentas") && document.getElementById("chartVentas")) {
        animarKPI("kpiVentas", 120, 2000);  // Ejemplo: 120 ventas
        const ctx = document.getElementById("chartVentas").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio"],
            datasets: [{
              label: "Ventas",
              data: [15, 20, 25, 30, 20, 10],
              borderColor: "#4CAF50",
              backgroundColor: "rgba(76, 175, 80, 0.2)",
              borderWidth: 2,
              tension: 0.3,
              pointRadius: 4,
              pointBackgroundColor: "#4CAF50"
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 1500 },
            scales: {
              y: { beginAtZero: true, title: { display: true, text: "Unidades" } },
              x: { title: { display: true, text: "Mes" } }
            },
            plugins: { legend: { display: false } }
          }
        });
      }
      
      // =======================================
      // 5. CHATBOT FALSO
      // =======================================
      const chatbotBtn = document.getElementById("chatbotBtn");
      const chatbotWindow = document.getElementById("chatbotWindow");
      const closeChatbot = document.getElementById("closeChatbot");
      const chatMessages = document.getElementById("chatMessages");
      const chatInput = document.getElementById("chatInput");
      const sendChatBtn = document.getElementById("sendChatBtn");
      
      let chatbotOpen = false;
      if (chatbotBtn) {
        chatbotBtn.addEventListener("click", () => {
          chatbotOpen = !chatbotOpen;
          chatbotWindow.style.display = chatbotOpen ? "flex" : "none";
        });
      }
      if (closeChatbot) {
        closeChatbot.addEventListener("click", () => {
          chatbotOpen = false;
          chatbotWindow.style.display = "none";
        });
      }
      if (sendChatBtn && chatInput) {
        sendChatBtn.addEventListener("click", sendMessage);
        chatInput.addEventListener("keydown", (e) => {
          if(e.key === "Enter") sendMessage();
        });
      }
      function sendMessage() {
        const msg = chatInput.value.trim();
        if (!msg) return;
        const userMsg = document.createElement("div");
        userMsg.classList.add("chat-message", "user");
        userMsg.innerText = msg;
        chatMessages.appendChild(userMsg);
        chatInput.value = "";
        const botMsg = document.createElement("div");
        botMsg.classList.add("chat-message", "bot");
        botMsg.innerText = "Este es un chatbot ficticio.";
        chatMessages.appendChild(botMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      // =======================================
      // 6. FUNCIONES EXTERNAS: KPI, MODALES, DEMO LOGIN, ETC.
      // =======================================
      
      // Animar el KPI (conteo ascendente)
      function animarKPI(elementId, endValue, duration) {
        let startValue = 0;
        const increment = endValue / (duration / 16);
        const obj = document.getElementById(elementId);
        const timer = setInterval(() => {
          startValue += increment;
          if (startValue >= endValue) {
            startValue = endValue;
            clearInterval(timer);
          }
          obj.textContent = Math.floor(startValue);
        }, 16);
      }
      
      // Funciones para modales de cursos/detalles
      function abrirModalCurso(idModal) {
        const modal = document.getElementById(idModal);
        if (modal) modal.style.display = "flex";
      }
      function cerrarModalCurso(idModal) {
        const modal = document.getElementById(idModal);
        if (modal) modal.style.display = "none";
      }
      
      // Funciones para popups de alertas (ahora globales)
      window.mostrarAlerta = function(titulo) {
        let detalleMensaje = "";
        if (titulo === "OFICINAS ADMINISTRATIVAS DE INVERNADEROS BONANZA 2001 (Jalisco)") {
          detalleMensaje = "Información detallada: Oficina principal ubicada en Jalisco. Llámanos al 55-XXXX-XXXX para agendar una cita.";
        } else if (titulo === "BAJA PK (Baja California)") {
          detalleMensaje = "Información detallada: Oficina en Baja California. El cliente ha confirmado interés, coordina seguimiento inmediato.";
        } else if (titulo === "HH AND SONS PRODUCE (Baja California Sur)") {
          detalleMensaje = "Información detallada: Empresa de Baja California Sur. Se requiere revisión y seguimiento urgente.";
        } else {
          detalleMensaje = "Información detallada para " + titulo;
        }
        document.getElementById("tituloAlerta").innerText = titulo;
        document.querySelector("#overlayAlerta p").innerText = detalleMensaje;
        document.getElementById("overlayAlerta").style.display = "flex";
      };

      window.cerrarAlerta = function() {
        document.getElementById("overlayAlerta").style.display = "none";
      };

      // Funciones para el modal de Propuesta de Venta
      let salesStatus = {}; // Estado de venta por id
      window.openProposalModal = function(companyId) {
        window.currentCompanyId = companyId;
        document.getElementById("proposalCompanyName").innerText = "Empresa " + companyId;
        document.getElementById("saleStatusText").innerText = salesStatus[companyId] || "Pendiente";
        document.getElementById("proposalModal").style.display = "flex";
      };
      const closeProposalModalBtn = document.getElementById("closeProposalModal");
      if (closeProposalModalBtn) {
        closeProposalModalBtn.addEventListener("click", () => {
          document.getElementById("proposalModal").style.display = "none";
        });
      }
      window.addEventListener("click", (e) => {
        if (e.target === document.getElementById("proposalModal")) {
          document.getElementById("proposalModal").style.display = "none";
        }
      });
      const markSaleClosedBtn = document.getElementById("markSaleClosedBtn");
      if (markSaleClosedBtn) {
        markSaleClosedBtn.addEventListener("click", () => {
          if (window.currentCompanyId) {
            salesStatus[window.currentCompanyId] = "Cerrado";
            document.getElementById("saleStatusText").innerText = "Cerrado";
          }
        });
      }
      const markSalePendingBtn = document.getElementById("markSalePendingBtn");
      if (markSalePendingBtn) {
        markSalePendingBtn.addEventListener("click", () => {
          if (window.currentCompanyId) {
            salesStatus[window.currentCompanyId] = "Pendiente";
            document.getElementById("saleStatusText").innerText = "Pendiente";
          }
        });
      }
      
      // Funciones para Demo Login
      window.abrirModalLogin = function() {
        const modal = document.getElementById("modalLogin");
        if (modal) modal.style.display = "flex";
      };
      window.cerrarModalLogin = function() {
        const modal = document.getElementById("modalLogin");
        if (modal) modal.style.display = "none";
      };
      window.demoLogin = function() {
        const user = document.getElementById("loginUser").value;
        const pass = document.getElementById("loginPass").value;
        if (user === "user" && pass === "user") {
          window.location.href = "home.html";
        } else {
          alert('Credenciales incorrectas. Usa "user"/"user".');
        }
        return false;
      };
      
      // Actualizar lista de clientes potenciales desde CSV (mostrando solo los 3 primeros)
      Papa.parse("clientes_potenciales_fertilizantes_enhanced.csv", {
        download: true,
        header: true,
        complete: function(results) {
          const data = results.data;
          const clientesUl = document.getElementById("clientesUl");
          if (clientesUl) {
            clientesUl.innerHTML = "";
            data.slice(0, 3).forEach(item => {
              const li = document.createElement("li");
              li.innerText = `${item.nom_estab} (${item.entidad})`;
              clientesUl.appendChild(li);
            });
          }
          const alertsContainer = document.querySelector(".alerts");
          if (alertsContainer) {
            alertsContainer.innerHTML = `
              <h2>Notificaciones</h2>
              <div class="alert-item">
                <p><strong>OFICINAS ADMINISTRATIVAS DE INVERNADEROS BONANZA 2001 (Jalisco)</strong><br>Cliente respondió y agendó cita.</p>
                <button onclick="mostrarAlerta('OFICINAS ADMINISTRATIVAS DE INVERNADEROS BONANZA 2001 (Jalisco)')">Ver Detalles</button>
              </div>
              <div class="alert-item">
                <p><strong>BAJA PK (Baja California)</strong><br>Cliente confirmó interés.</p>
                <button onclick="mostrarAlerta('BAJA PK (Baja California)')">Ver Detalles</button>
              </div>
              <div class="alert-item">
                <p><strong>HH AND SONS PRODUCE (Baja California Sur)</strong><br>Cliente solicita seguimiento.</p>
                <button onclick="mostrarAlerta('HH AND SONS PRODUCE (Baja California Sur)')">Ver Detalles</button>
              </div>
            `;
          }
        }
      });

      // Actualizar lista de clientes potenciales basada en GeoJSON (limitando a 3)
      function updateClientesList(features) {
        const clientesUl = document.getElementById("clientesUl");
        if (clientesUl) {
          clientesUl.innerHTML = "";
          features.slice(0, 3).forEach(feature => {
            const li = document.createElement("li");
            li.innerText = `${feature.nom_estab} (${feature.entidad})`;
            clientesUl.appendChild(li);
          });
        }
      }

      // Manejo del menú de usuario
      const userAvatar = document.querySelector('.avatar');
      const userMenu = document.getElementById('userMenu');
      
      userAvatar.addEventListener('click', (e) => {
        e.stopPropagation();
        userMenu.classList.toggle('show');
      });

      // Manejo del selector de periodo
      const periodButton = document.getElementById('periodButton');
      const periodMenu = document.getElementById('periodMenu');
      
      periodButton.addEventListener('click', (e) => {
        e.stopPropagation();
        periodMenu.classList.toggle('show');
      });

      // Cerrar menús al hacer clic fuera
      document.addEventListener('click', () => {
        userMenu.classList.remove('show');
        periodMenu.classList.remove('show');
      });

      // Prevenir cierre al hacer clic dentro de los menús
      userMenu.addEventListener('click', (e) => e.stopPropagation());
      periodMenu.addEventListener('click', (e) => e.stopPropagation());

      // Actualizar el texto del botón de periodo al seleccionar una opción
      const periodOptions = periodMenu.querySelectorAll('a');
      periodOptions.forEach(option => {
        option.addEventListener('click', (e) => {
          e.preventDefault();
          const selectedText = option.textContent;
          periodButton.innerHTML = `${selectedText} <i class="fas fa-chevron-down"></i>`;
          
          // Actualizar clase activa
          periodOptions.forEach(opt => opt.classList.remove('active'));
          option.classList.add('active');
          
          periodMenu.classList.remove('show');
        });
      });
    });
  </script>
</body>
</html>